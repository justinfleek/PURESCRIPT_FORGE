# Buck2 build file for compiler pipeline
#
# Uses aleph toolchains for hermetic builds with Nix store paths.
# Paths are read from .buckconfig.local, generated by `nix develop`.
#
# Structure follows aleph conventions:
#   - Uses glob() for source discovery
#   - Uses toolchains for enhanced rules
#   - Uses shortlist for C++ libraries
#   - Proper visibility declarations

# Load prelude rules (standard Buck2)
load("@prelude//cxx:cxx.bzl", "cxx_binary", "cxx_library")
load("@prelude//haskell:haskell.bzl", "haskell_binary")

# Load aleph toolchains (enhanced rules with packages/extensions)
load("@toolchains//:haskell.bzl", 
    toolchains_haskell_binary = "haskell_binary",
    "haskell_library",
)
load("@toolchains//:cxx.bzl", "cxx_binary", "cxx_library")
load("@toolchains//:lean.bzl", "lean_library")
load("@toolchains//:shortlist.bzl", "shortlist_all")

# Define shortlist libraries (if configured in .buckconfig.local)
shortlist_all()

# PureScript → C++23 compiler
# Uses toolchains rule for package dependencies
toolchains_haskell_binary(
    name = "purescript-to-cpp23",
    srcs = glob([
        "purescript-to-cpp23/src/*.hs",
    ]),
    main = "Main",
    packages = [
        "base",
        "megaparsec",
        "text",
        "bytestring",
        "containers",
    ],
    language_extensions = [
        "OverloadedStrings",
    ],
    ghc_options = ["-O2", "-Wall"],
    visibility = ["PUBLIC"],
)

# C++23 → React generator
# Uses standard cxx_binary (prelude rule)
# libclang comes from .buckconfig.local [cxx] section
cxx_binary(
    name = "cpp23-to-react",
    srcs = glob([
        "cpp23-to-react/src/*.cpp",
    ]),
    headers = glob([
        "cpp23-to-react/src/*.h",
    ]),
    compiler_flags = [
        "-std=c++23",
        "-O2",
    ],
    # libclang paths come from .buckconfig.local [cxx] section
    # Shortlist libraries available as toolchains//:fmt, toolchains//:spdlog, etc.
    visibility = ["PUBLIC"],
)

# Runtime WASM library
cxx_library(
    name = "runtime-wasm",
    srcs = glob([
        "runtime/src/*.cpp",
    ]),
    compiler_flags = ["-std=c++23"],
    link_style = "static",
    # Note: emscripten would need special handling for WASM targets
    visibility = ["PUBLIC"],
)

# Haskell → C++23 compiler
toolchains_haskell_binary(
    name = "haskell-to-cpp23",
    srcs = glob([
        "haskell-to-cpp23/src/*.hs",
    ]),
    packages = [
        "base",
        "ghc-core",
    ],
    ghc_options = ["-O2", "-Wall"],
    visibility = ["PUBLIC"],
)

# Lean4 → C++23 compiler
lean_library(
    name = "lean4-to-cpp23",
    srcs = glob([
        "lean4-to-cpp23/src/*.lean",
    ]),
    visibility = ["PUBLIC"],
)

# Complete compiler pipeline (meta target)
# Note: This is a convenience alias, not a real binary
alias(
    name = "compiler-pipeline",
    actual = ":purescript-to-cpp23",
    visibility = ["PUBLIC"],
)
