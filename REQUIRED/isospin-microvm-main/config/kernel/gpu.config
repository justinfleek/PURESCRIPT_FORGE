# GPU passthrough kernel config additions
# Merge with base firecracker config

# Enable loadable modules (required for NVIDIA driver)
CONFIG_MODULES=y
CONFIG_MODULE_UNLOAD=y
CONFIG_MODULE_FORCE_UNLOAD=y
CONFIG_MODVERSIONS=y
CONFIG_MODULE_SRCVERSION_ALL=y
CONFIG_MODULE_COMPRESS_NONE=y

# Virtio MMIO command line devices (needed for Firecracker without VFIO)
CONFIG_VIRTIO_MMIO_CMDLINE_DEVICES=y

# PCI support (from pcie.config + extras)
CONFIG_BLK_MQ_PCI=y
CONFIG_PCI=y
CONFIG_PCI_MMCONFIG=y
CONFIG_PCI_MSI=y
CONFIG_PCIEPORTBUS=y
CONFIG_PCIEASPM=y
CONFIG_PCIE_PME=y
CONFIG_PCI_MSI_IRQ_DOMAIN=y
CONFIG_VIRTIO_PCI=y
CONFIG_PCI_HOST_COMMON=y
CONFIG_PCI_HOST_GENERIC=y

# IOMMU for VFIO passthrough
CONFIG_IOMMU_SUPPORT=y
CONFIG_IOMMU_API=y
CONFIG_AMD_IOMMU=y
CONFIG_AMD_IOMMU_V2=y
CONFIG_INTEL_IOMMU=y
CONFIG_INTEL_IOMMU_SVM=y
CONFIG_IRQ_REMAP=y
CONFIG_VFIO=y
CONFIG_VFIO_PCI=y
CONFIG_VFIO_IOMMU_TYPE1=y

# DRM (Direct Rendering Manager) - required for GPU
CONFIG_DRM=y
CONFIG_DRM_FBDEV_EMULATION=y
CONFIG_DRM_FBDEV_OVERALLOC=100

# Memory management for GPU
CONFIG_ZONE_DEVICE=y
CONFIG_MEMORY_HOTPLUG=y
CONFIG_MEMORY_HOTREMOVE=y
CONFIG_TRANSPARENT_HUGEPAGE=y
CONFIG_TRANSPARENT_HUGEPAGE_ALWAYS=y

# Required for NVIDIA driver
CONFIG_DEVTMPFS=y
CONFIG_DEVTMPFS_MOUNT=y
CONFIG_TMPFS=y
CONFIG_SHMEM=y
CONFIG_MTRR=y
CONFIG_X86_PAT=y

# MMU notifier (required for nvidia-uvm)
CONFIG_MMU_NOTIFIER=y

# Framebuffer support
CONFIG_FB=y
CONFIG_FB_CORE=y
CONFIG_FB_VESA=y
CONFIG_FB_EFI=y

# Character devices
CONFIG_VT=y
CONFIG_VT_CONSOLE=y
CONFIG_HW_CONSOLE=y

# Kernel symbols for module building
CONFIG_KALLSYMS=y
CONFIG_KALLSYMS_ALL=y

# Debug filesystem (helps nvidia driver)
CONFIG_DEBUG_FS=y
